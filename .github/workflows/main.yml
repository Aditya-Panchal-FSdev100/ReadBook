name: ASP.NET Deploy to IIS

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '9.0.x'

    - name: Restore NuGet packages
      run: dotnet restore

    - name: Build with dotnet
      run: dotnet build --configuration Release

    - name: Publish with dotnet
      run: dotnet publish --configuration Release --output "C:\Users\nares\Documents\BOOKGA\ReadBook"

    - name: Deploy to IIS
      run: |
        # Stop IIS
          iisreset /stop
          
          # Define the local and IIS bin directories
          $localBin = 'C:\Users\nares\Documents\BOOKGA\ReadBook\bin'
          $iisBin = 'C:\IISPublish\ReadBook.com\bin'
          
          # Ensure IIS bin directory exists
          if (!(Test-Path $iisBin)) {
              New-Item -ItemType Directory -Force -Path $iisBin
          }
          
          # Get the list of files from the local bin and IIS bin
          $localFiles = Get-ChildItem -Path $localBin -Recurse
          $iisFiles = Get-ChildItem -Path $iisBin -Recurse
          
          # Compare and copy files
          foreach ($localFile in $localFiles) {
              # Get the corresponding file in IIS bin
              $relativePath = $localFile.FullName.Substring($localBin.Length)
              $iisFilePath = Join-Path $iisBin $relativePath
              $iisFile = Get-Item -Path $iisFilePath -ErrorAction SilentlyContinue
              
              # If the IIS file doesn't exist or the local file is newer, copy it using xcopy
              if ($iisFile -eq $null -or $localFile.LastWriteTime -gt $iisFile.LastWriteTime) {
                  Write-Host "Copying file: $localFile.FullName to $iisFilePath"
                  xcopy $localFile.FullName $iisFilePath /s /y
              }
          }
          
          Write-Host 'Modified files have been copied to IIS bin.'

        iisreset /start
